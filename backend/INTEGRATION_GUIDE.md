# Integration Guide - API Keys & Referrals

This guide explains how to integrate the new API Key Management and Referral Program modules into your PT SaaS platform.

## 1. Database Migration

Run the SQL migrations to create the required tables:

```bash
# Run migrations (assuming you have a migration script)
mysql -u your_user -p your_database < database/migrations/007_api_keys.sql
mysql -u your_user -p your_database < database/migrations/008_referrals.sql
```

### Tables Created

**API Keys:**
- `api_keys` - Stores API key credentials and metadata
- `api_logs` - Logs all API requests for analytics and rate limiting

**Referrals:**
- `referral_codes` - Stores referral codes generated by users
- `referral_conversions` - Tracks when referral codes are used
- `referral_rewards` - Tracks rewards awarded (optional, for advanced features)

## 2. Install Dependencies

Ensure these packages are installed:

```bash
npm install bcrypt crypto
```

These are likely already installed, but verify in your `package.json`.

## 3. Register Routes in Server

Add these lines to `backend/src/server.js`:

```javascript
// Import new routes (add to imports section around line 34)
const apiKeyRoutes = require('./routes/apiKey.routes');
const referralRoutes = require('./routes/referral.routes');

// Register routes (add to routes section around line 152)
app.use('/api/api-keys', apiKeyRoutes);
app.use('/api/referrals', referralRoutes);
```

## 4. API Key Management

### Endpoints

#### Generate API Key
```http
POST /api/api-keys
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "name": "Production API Key",
  "permissions": {
    "clients": { "read": true, "write": true },
    "workouts": { "read": true },
    "rateLimit": 5000
  },
  "expiresInDays": 365
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Production API Key",
    "apiKey": "ptk_a1b2c3d4e5f6...",
    "apiSecret": "1234567890abcdef...",
    "permissions": { ... },
    "rateLimit": 5000,
    "expiresAt": "2027-02-15T10:00:00.000Z",
    "warning": "Store the API secret securely. It will not be shown again."
  }
}
```

**Important:** The `apiSecret` is only shown once. Store it securely.

#### List API Keys
```http
GET /api/api-keys
Authorization: Bearer <jwt_token>
```

#### Get Usage Statistics
```http
GET /api/api-keys/usage?apiKeyId=1
Authorization: Bearer <jwt_token>
```

#### Revoke API Key
```http
DELETE /api/api-keys/1
Authorization: Bearer <jwt_token>
```

### Using API Keys for Authentication

To authenticate with API keys instead of JWT tokens, add these headers to your requests:

```http
GET /api/clients
X-API-Key: ptk_a1b2c3d4e5f6...
X-API-Secret: 1234567890abcdef...
```

**Example with API Key Authentication:**

Create a protected API endpoint that accepts both JWT and API Key auth:

```javascript
const { verifyToken } = require('../middlewares/auth');
const { apiAuth, requireApiPermission } = require('../middlewares/apiKeyAuth');

// Option 1: JWT only
router.get('/clients', verifyToken, controller.list);

// Option 2: API Key only
router.get('/api/v1/clients', apiAuth, requireApiPermission('clients.read'), controller.list);

// Option 3: Accept both JWT and API Key (either/or)
// You would need to create a custom middleware that tries JWT first, then API key
```

## 5. Referral Program

### Endpoints

#### Generate Referral Code
```http
POST /api/referrals/codes
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "type": "trainer",
  "customCode": "MYCODE123"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "code": "MYCODE123",
    "type": "trainer",
    "referrerReward": 25.00,
    "refereeReward": 15.00,
    "status": "active"
  }
}
```

**Referral Types:**
- `general` - Default (€10 referrer, €10 referee)
- `trainer` - For trainers (€25 referrer, €15 referee)
- `client` - For clients (€5 referrer, €5 referee)
- `promotion` - Promotional campaigns (€0 referrer, €20 referee)

#### Apply Referral Code
```http
POST /api/referrals/apply
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "code": "MYCODE123"
}
```

#### Get Referral Stats
```http
GET /api/referrals/stats
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "totalCodes": 3,
    "totalConversions": 15,
    "completedConversions": 12,
    "pendingConversions": 3,
    "totalEarnings": 300.00,
    "conversionRate": "80.00",
    "recentConversions": [ ... ]
  }
}
```

#### List User's Referral Codes
```http
GET /api/referrals/codes
Authorization: Bearer <jwt_token>
```

#### List Conversions
```http
GET /api/referrals/conversions?status=completed
Authorization: Bearer <jwt_token>
```

#### Complete Conversion (Owner/Admin only)
```http
PUT /api/referrals/conversions/1/complete
Authorization: Bearer <jwt_token>
```

This endpoint is used to mark a conversion as "completed" after certain conditions are met (e.g., referred user pays first month).

## 6. Frontend Integration Examples

### API Key Management Component

```javascript
// Generate API Key
const generateApiKey = async () => {
  const response = await fetch('/api/api-keys', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: 'My API Key',
      permissions: {
        clients: { read: true, write: false },
        workouts: { read: true }
      }
    })
  });

  const data = await response.json();

  // IMPORTANT: Show the apiSecret to user and warn them to save it
  alert(`API Secret: ${data.data.apiSecret}\n\nSave this now - it won't be shown again!`);
};
```

### Referral Code Component

```javascript
// Generate referral code
const generateReferralCode = async () => {
  const response = await fetch('/api/referrals/codes', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: 'trainer'
    })
  });

  const data = await response.json();
  return data.data.code;
};

// Apply referral code during signup
const applyReferralCode = async (code) => {
  const response = await fetch('/api/referrals/apply', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ code })
  });

  return await response.json();
};
```

## 7. Security Considerations

### API Keys
1. **Never log API secrets** - They are hashed in the database and should never be stored in plaintext
2. **Use HTTPS only** - API keys should never be transmitted over HTTP
3. **Implement rate limiting** - The service includes rate limit tracking
4. **Rotate keys regularly** - Encourage users to regenerate keys periodically
5. **Audit logs** - All API requests are logged in `api_logs` table

### Referrals
1. **Prevent self-referral** - The service blocks users from using their own codes
2. **One code per user** - Each user can only use one referral code
3. **Validate conversions** - Use the "complete conversion" endpoint after verifying payment
4. **Expiration** - Set expiration dates for promotional codes
5. **Max uses** - Limit promotional code usage

## 8. Webhooks & Automation

### Auto-complete Referral Conversions

You can integrate referral conversion completion with your payment system:

```javascript
// In your payment webhook handler
const paymentService = require('./services/payment.service');
const referralService = require('./services/referral.service');

paymentWebhook.on('payment.succeeded', async (event) => {
  const userId = event.userId;

  // Check if this user has a pending referral conversion
  const conversions = await referralService.listConversions(userId, 'pending');

  if (conversions.length > 0) {
    // Complete the conversion and award rewards
    await referralService.completeConversion(conversions[0].id, tenantId);
  }
});
```

## 9. Testing

### Test API Key Flow
```bash
# 1. Generate API key
curl -X POST http://localhost:3000/api/api-keys \
  -H "Authorization: Bearer YOUR_JWT" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Key","permissions":{}}'

# 2. Use API key to access endpoint
curl -X GET http://localhost:3000/api/clients \
  -H "X-API-Key: ptk_..." \
  -H "X-API-Secret: ..."
```

### Test Referral Flow
```bash
# 1. Generate code
curl -X POST http://localhost:3000/api/referrals/codes \
  -H "Authorization: Bearer USER1_JWT" \
  -d '{"type":"general"}'

# 2. Apply code (as different user)
curl -X POST http://localhost:3000/api/referrals/apply \
  -H "Authorization: Bearer USER2_JWT" \
  -d '{"code":"ABC12345"}'

# 3. Check stats
curl -X GET http://localhost:3000/api/referrals/stats \
  -H "Authorization: Bearer USER1_JWT"
```

## 10. Next Steps

1. **Create frontend UI** - Build components for managing API keys and referrals
2. **Add email notifications** - Notify users when referrals convert
3. **Dashboard analytics** - Display referral performance metrics
4. **Webhook system** - Allow external systems to subscribe to events
5. **Advanced permissions** - Implement granular API key permissions
6. **Referral tiers** - Create multi-level referral rewards

## Support

For questions or issues, refer to the service files:
- `backend/src/services/apiKey.service.js`
- `backend/src/services/referral.service.js`
- `backend/src/middlewares/apiKeyAuth.js`
