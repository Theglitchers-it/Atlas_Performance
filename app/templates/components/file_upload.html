<!-- File Upload Component -->
<!--
Usage:
{% include 'components/file_upload.html' with upload_type='avatar', upload_url=url_for('uploads.upload_avatar') %}

Parameters:
- upload_type: 'avatar', 'image', 'video', 'check_in'
- upload_url: Route endpoint for upload
- accept: File types (optional, defaults based on type)
- max_size_mb: Max file size in MB (optional)
- preview: Show preview (default true)
- multiple: Allow multiple files (default false)
-->

{% set upload_id = upload_id|default('file-upload-' ~ range(1000, 9999)|random) %}
{% set accept_types = accept|default(
    'image/*' if upload_type in ['avatar', 'image', 'check_in'] else 'video/*'
) %}
{% set max_size = max_size_mb|default(50 if upload_type == 'video' else 5) %}
{% set show_preview = preview|default(true) %}
{% set allow_multiple = multiple|default(false) %}

<div class="upload-container" id="{{ upload_id }}-container">
    <!-- Upload Area -->
    <div class="upload-dropzone border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 transition cursor-pointer"
         id="{{ upload_id }}-dropzone"
         ondrop="handleDrop{{ upload_id }}(event)"
         ondragover="handleDragOver(event)"
         ondragleave="handleDragLeave(event)">

        <input type="file"
               id="{{ upload_id }}"
               class="hidden"
               accept="{{ accept_types }}"
               {% if allow_multiple %}multiple{% endif %}
               onchange="handleFileSelect{{ upload_id }}(event)">

        <div class="upload-prompt" id="{{ upload_id }}-prompt">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas {% if upload_type == 'video' %}fa-video{% else %}fa-image{% endif %} text-blue-600 text-2xl"></i>
            </div>
            <p class="text-lg font-semibold text-gray-900 mb-2">
                Drop your {% if upload_type == 'video' %}video{% else %}image{% endif %} here or click to browse
            </p>
            <p class="text-sm text-gray-600">
                Max size: {{ max_size }}MB
                {% if allow_multiple %}(Multiple files allowed){% endif %}
            </p>
        </div>

        <!-- Loading State -->
        <div class="upload-loading hidden" id="{{ upload_id }}-loading">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
            <p class="text-gray-700 font-medium">Uploading...</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-3 max-w-xs mx-auto">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                     id="{{ upload_id }}-progress"
                     style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Preview Area -->
    {% if show_preview %}
    <div class="upload-preview mt-4 hidden" id="{{ upload_id }}-preview">
        <div class="grid {% if allow_multiple %}grid-cols-2 md:grid-cols-3{% else %}grid-cols-1{% endif %} gap-4"
             id="{{ upload_id }}-preview-grid">
        </div>
    </div>
    {% endif %}

    <!-- Error Display -->
    <div class="upload-error mt-4 hidden" id="{{ upload_id }}-error">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                <span class="text-red-700 font-medium" id="{{ upload_id }}-error-text"></span>
            </div>
        </div>
    </div>
</div>

<script>
// File upload handler for {{ upload_id }}
(function() {
    const uploadUrl = "{{ upload_url }}";
    const uploadType = "{{ upload_type }}";
    const maxSizeMB = {{ max_size }};
    const allowMultiple = {{ 'true' if allow_multiple else 'false' }};

    const dropzone = document.getElementById('{{ upload_id }}-dropzone');
    const fileInput = document.getElementById('{{ upload_id }}');
    const prompt = document.getElementById('{{ upload_id }}-prompt');
    const loading = document.getElementById('{{ upload_id }}-loading');
    const preview = document.getElementById('{{ upload_id }}-preview');
    const previewGrid = document.getElementById('{{ upload_id }}-preview-grid');
    const error = document.getElementById('{{ upload_id }}-error');
    const errorText = document.getElementById('{{ upload_id }}-error-text');
    const progress = document.getElementById('{{ upload_id }}-progress');

    // Click to open file dialog
    dropzone.addEventListener('click', function() {
        fileInput.click();
    });

    // Handle file selection
    window.handleFileSelect{{ upload_id }} = function(event) {
        const files = event.target.files;
        if (files.length > 0) {
            uploadFiles(files);
        }
    };

    // Handle drag and drop
    window.handleDrop{{ upload_id }} = function(event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.remove('border-blue-500', 'bg-blue-50');

        const files = event.dataTransfer.files;
        if (files.length > 0) {
            uploadFiles(files);
        }
    };

    // Upload files
    function uploadFiles(files) {
        // Hide error
        error.classList.add('hidden');

        // Validate file size
        for (let file of files) {
            if (file.size > maxSizeMB * 1024 * 1024) {
                showError(`File "${file.name}" is too large. Max size: ${maxSizeMB}MB`);
                return;
            }
        }

        // Show loading
        prompt.classList.add('hidden');
        loading.classList.remove('hidden');

        // Prepare form data
        const formData = new FormData();

        if (allowMultiple) {
            for (let file of files) {
                formData.append('files[]', file);
            }
        } else {
            formData.append('file', files[0]);
        }

        // Add additional data if needed
        {% if additional_data %}
        {% for key, value in additional_data.items() %}
        formData.append('{{ key }}', '{{ value }}');
        {% endfor %}
        {% endif %}

        // Upload with progress
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progress.style.width = percentComplete + '%';
            }
        });

        xhr.addEventListener('load', function() {
            loading.classList.add('hidden');
            prompt.classList.remove('hidden');
            progress.style.width = '0%';

            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);

                    if (response.success) {
                        showPreview(response);

                        // Trigger custom event
                        const event = new CustomEvent('uploadComplete', {
                            detail: response
                        });
                        document.dispatchEvent(event);

                        // Call callback if defined
                        if (typeof window.onUploadComplete{{ upload_id }} === 'function') {
                            window.onUploadComplete{{ upload_id }}(response);
                        }
                    } else {
                        showError(response.error || 'Upload failed');
                    }
                } catch (e) {
                    showError('Invalid server response');
                }
            } else {
                try {
                    const response = JSON.parse(xhr.responseText);
                    showError(response.error || 'Upload failed');
                } catch (e) {
                    showError('Upload failed');
                }
            }
        });

        xhr.addEventListener('error', function() {
            loading.classList.add('hidden');
            prompt.classList.remove('hidden');
            progress.style.width = '0%';
            showError('Network error occurred');
        });

        xhr.open('POST', uploadUrl, true);
        xhr.send(formData);
    }

    // Show preview
    function showPreview(response) {
        preview.classList.remove('hidden');

        const files = response.files || [response];

        previewGrid.innerHTML = '';

        files.forEach(file => {
            const previewItem = document.createElement('div');
            previewItem.className = 'relative group';

            if (uploadType === 'video') {
                previewItem.innerHTML = `
                    <video class="w-full h-48 object-cover rounded-lg" controls>
                        <source src="${file.url}" type="video/mp4">
                    </video>
                    <button onclick="deleteFile('${file.url}')"
                            class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                previewItem.innerHTML = `
                    <img src="${file.url}" class="w-full h-48 object-cover rounded-lg" alt="Preview">
                    <button onclick="deleteFile('${file.url}')"
                            class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }

            previewGrid.appendChild(previewItem);
        });
    }

    // Show error
    function showError(message) {
        errorText.textContent = message;
        error.classList.remove('hidden');
    }

    // Delete file (stub - implement as needed)
    window.deleteFile = function(url) {
        if (confirm('Delete this file?')) {
            fetch('{{ url_for("uploads.delete_file") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Deletion failed');
                }
            })
            .catch(() => alert('Network error'));
        }
    };
})();

// Drag and drop helpers
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
}
</script>
